---
title: "Building the Perfect Soccer Player"
author: "team-devils"
date: "Dec 14, 2018"
runtime: shiny
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_packages, include = FALSE}
library(tidyverse)
library(broom)
library(rvest)
library(infer)
library(modelr)
library(knitr)
library(shiny)
library(tools)
library(shinythemes)
```



## Introduction

While soccer’s popularity may be somewhat subdued in the United States, soccer is not only one of the most widely followed sports in the world, but also a deeply significant shared cultural experience. According to the Global World Research Index, 3.2 billion individuals across the globe watched at least one portion of the 2018 FIFA World Cup. In July of 2018, Portuguese forward Cristiano Ronaldo transferred from Spanish club Real Madrid to Italian club Juventus in a €100 million deal. What combination of factors led to this one soccer player’s multi-million dollar evaluation? Our team aims to discover what makes the most valuable soccer player. We will use data of players in the 2018-2019 season of the professional European club soccer league. We selected the information of players in this league over others due to the fact that besides the World Cup, the professional European league is the highest watched and most widely analyzed league in the world. Through visualizations exploring patterns between markers of success in the sport of soccer (such as number of assists, number of goals, etc.), markers of failure (such as number of substitutions off the playing field, number of own goals, etc.), and market value. In order to answer our central question, we plan to use linear regression and modeling to assist us in creating the most valuable soccer player. Our data is a collection of the top 500 most valuable players in the 2018-2019 European club season (data collected on 11/27/2018). We recognize that by using the top 500 players by market value (which is in and of itself a biased measure), we have a sample which is biased and may be right skewed in terms of market value. We will not be conducting hypothesis testing due to the former and we will explore possibly analyzing our data after using a transformation to account for the latter. The data comes from a professional German soccer statistics website titled “Transfermarkt”, which is a website dedicated to tracking players’ market values and performances. Transfermarkt.com is a leading medium in reporting soccer transfer news and they have connections with all of the major leagues and clubs across Europe, South America, and Asia. The player statistics are generated after each match and analyzed by professional scouts, soccer analysts and data scientists. Each observation is a player, and includes the variables name, position, number of matches, number of goals scored, number of own goals, number of assists, number of yellow cards, number of red cards, number of substitutions on, number of substitutions off, and market value. The data was obtained from transfermarkt.com through web scraping tools learned from the course.


## Data Analysis

```{r load-data, include = FALSE}
players1 <- read_csv("../data/players1.csv")
```

To get a general sense of the market values of all players in the 2018-2019 season, let's first create a histogram to visualize their distribution: 

```{r histogram, fig.width = 10}
players1 %>%
  ggplot(mapping = aes(market_value, fill = ..count..)) +
  geom_histogram(binwidth = 5) +
  labs(
    title = "Distribution of Player Market Values in 2018-2019 Season",
    x = "Player Market Values in 2018-2019 Season", 
    y = "Count"
  ) +
  theme_minimal() +
  scale_fill_gradient(low="blue", high="red")
```

In the histogram above, we can see that the distribution of the players' market values in the 2018-2019 season is right-skewed, and that the most commonly occuring market value is around $23 million. In the summary statistics below, we can see that the mean of the market values is higher than the most commonly occuring market values due to the right skewedness of the data: 

```{r summary-stats}
players1 %>%
  summarise(mean = mean(market_value), median = median(market_value), sd = sd(market_value), min = min(market_value), max = max(market_value))

```

The median, however, seems to be affected to a lesser extent by the high valued outliers. In the boxplot below, the blue colored line represents the median, and the red line represents the mean: 

```{r boxplot, fig.height = 5, fig.width = 10}
players1 %>%
  ggplot(mapping = aes(y = market_value)) +
  geom_boxplot() +
  coord_flip() +
  labs(
    title = "Boxplot of Player Market Values in 2018-2019 Season",
    y = "Player Market Values in 2018-2019 season"
  ) +
  theme_minimal() +
  geom_hline(yintercept = 35.3, color = "red") +
  geom_hline(yintercept = 25, color = "blue")

# Coloring code found on http://www.sthda.com/english/wiki/ggplot2-colors-how-to-change-colors-automatically-and-manually
```

The boxplot also revealed that there are many outliers in the data. The table below shows the names and market values of the outlying soccer players: 

```{r outliers}
players1 %>%
  select(name, market_value) %>%
  filter(market_value > 75) %>%
  kable()

```

These players have extremely high market values compared to the rest of the players. Which raises the question: do they contribute much more than the other players? Let a player's contribution be the sum of the player's goals and assists, the following boxplots compare the contributions of the outlying players to that of the "normal" players: 

```{r outliers-plot, fig.width = 10}
players1 <- players1 %>%
  mutate(outlier = ifelse(
    market_value >75, T, F
  ), 
  contribution = goals + assists
  )

players1 %>%
  ggplot(mapping = aes(x = outlier, y = contribution, color = outlier)) +
  scale_color_manual(values = c("blue", "red")) +
  geom_boxplot() +
  labs(
    title = "Boxplot of Player Contributions in 2018-2019 Season",
    x = "Outlier (True/False)", 
    y = "Count"
  ) +
  guides(color = "none") +
  coord_flip() +
  theme_minimal() 
```

We can see from the comparison above that the outlying soccer players with very high market values do contribute significantly more, therefore their high market value is justified.

Now we would like to investigate the relationship between a player's position and the number of goals they score. In order to reduce confusion, we condensed our data of 13 player positions into 4: Defender, Forward, Goalkeeper, and Midfielder. We found the average goals made by each position and average assists made by each position: 

```{r position-goals, fig.height = 4, fig.width = 10}
position_goals <- players1 %>%
  group_by(position_new) %>%
  summarise(goals_avg = mean(goals), assists_avg = mean(assists))

position_goals

position_goals %>%
  mutate(position_new = fct_reorder(position_new, goals_avg)) %>%
  ggplot(mapping = aes(x = position_new, y = goals_avg)) +
  geom_col(fill = "blue") +
  labs(
    title = "Average Goals Scored in Each Position in the 2018-2019 Season",
    x = "Position", 
    y = "Average Goals Scored"
  ) +
  coord_flip() +
  theme_minimal()

position_goals %>%
  mutate(position_new = fct_reorder(position_new, assists_avg)) %>%
  ggplot(mapping = aes(x = position_new, y = assists_avg)) +
  geom_col(fill = "purple") +
  labs(
    title = "Average Assists in Each Position in the 2018-2019 Season",
    x = "Position", 
    y = "Average Assists"
  ) +
  coord_flip() +
  theme_minimal()
```

From the visualizations above, we can see that forward players have the most goals and assists on average, followed by midfielder, defender and goalkeeper. This is expected because forward players are the closest to the goal of the opposing team, making them the most likely to score and assist goals. Midfielders are the second closest, followed by defenders and goalkeepers. Interestingly, the average assists for goalkeeper is greater than 0. Let's find out which goalkeeper assisted a goal: 

```{r goal-assist}
players1 %>%
  select(name, position_new, assists) %>%
  filter(position_new == "Goalkeeper", assists > 0)
```

It looks like Ederson is the only goalkeeper who assisted a goal in the 2018-2019 season. 


### What Makes a Valuable Soccer Player? 

Below is an interactive scatterplot where we plot all numerical values against each other to find patterns. The opacity of the data points are reduced so that we can better visualize overlapping data. 

```{r shiny-app, echo = F}
shinyApp(

ui <- fluidPage(
  theme = shinytheme("cyborg"),
  titlePanel("Interactive Player Info Visualization"),
  sidebarLayout(
    sidebarPanel(
      selectInput(
        inputId = "y",
        label = "Y-axis:",
        choices = c(
          "Position" = "position",
          "Age" = "age",
          "Matches" = "matches",
          "Goals" = "goals",
          "Own Goals" = "own_goals",
          "Assists" = "assists",
          "Yellow Cards" = "yellow_cards",
          "Red Cards" = "red_cards",
          "Substituted On" = "substituted_on",
          "Substituted Off" = "substituted_off",
          "Market Value" = "market_value",
          "Age Range" = "age_range"
        ),
        selected = "position"
      ),
      selectInput(
        inputId = "x",
        label = "X-axis:",
        choices = c(
          "Position" = "position",
          "Age" = "age",
          "Matches" = "matches",
          "Goals" = "goals",
          "Own Goals" = "own_goals",
          "Assists" = "assists",
          "Yellow Cards" = "yellow_cards",
          "Red Cards" = "red_cards",
          "Substituted On" = "substituted_on",
          "Substituted Off" = "substituted_off",
          "Market Value" = "market_value",
          "Age Range" = "age_range"
        ),
        selected = "market_value"
      ),
      selectInput(
        inputId = "z",
        label = "Color by:",
        choices = c(
          "Position" = "position",
          "Age" = "age",
          "Matches" = "matches",
          "Goals" = "goals",
          "Own Goals" = "own_goals",
          "Assists" = "assists",
          "Yellow Cards" = "yellow_cards",
          "Red Cards" = "red_cards",
          "Substituted On" = "substituted_on",
          "Substituted Off" = "substituted_off",
          "Market Value" = "market_value",
          "Age Range" = "age_range"
        ),
        selected = "age"
      )
    ),
    mainPanel(plotOutput(outputId = "scatterplot"))
  )
),

server <- function(input, output) {

  # Create scatterplot object the plotOutput function is expecting
  output$scatterplot <- renderPlot({
    ggplot(data = players1, aes_string(
      x = input$x, y = input$y,
      color = input$z
    )) +
      geom_point(alpha = 0.2) +
      labs(
        x = toTitleCase(str_replace_all(input$x, "_", " ")),
        y = toTitleCase(str_replace_all(input$y, "_", " ")),
        color = toTitleCase(str_replace_all(input$z, "_", " "))
      ) +
      scale_color_gradient(low="blue", high="red") +
      theme_minimal()
  })
},

options = list(height = 500)
)
```

To begin with, we made a multiple linear regression based on all the variables we have in the players dataset. In soccer, player's position is highly correlated with his performances, especially goals and assists (e.g. Centre-Forwards get most goals and Midfielders make most assists in general while Goalkeepers can seldom score a goal or make an assist). Therefore, we decided to introduce two interactions between position/goals and position/assists into our multiple linear model. 

```{r predict}
linear_prediction  <- lm(market_value ~ position_new + age + matches + goals + own_goals +
                  assists + yellow_cards + red_cards + substituted_on +
                  substituted_off + age_range + position_new * goals + position_new * assists, data =   players1)
tidy(linear_prediction)
```


```{r AIC-selection, include = FALSE}
selected_model <- step(linear_prediction, direction = "backward")
```

```{r glance-AIC}
tidy(selected_model)


glance(linear_prediction)$AIC
glance(selected_model)$AIC
```

Through the model selection based on AIC, we can see that the variables "age", "own_goals", "yellow_cards", "red_cards", "substituted_on", substituted_off" are eliminated. The AIC is reduced compared to the previous dataset (4513.152 to 4504.674), which can be interpreted as the increased likelihood of the model.

```{r r-squared}
glance(selected_model)$r.squared
```

```{r cross_validation}
test_cv <- crossv_kfold(players1, 10)
models <- map(test_cv$train, ~ selected_model)
rmses <- map2_dbl(models, test_cv$test, rmse)
rmses
```




## Conclusion

Your project goes here! Before you submit, make sure your chunks are turned off with `echo = FALSE`. 

You can add sections as you see fit. Make sure you have a section called Introduction at the beginning and a section called Conclusion at the end. The rest is up to you!
